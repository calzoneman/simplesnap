// Generated by CoffeeScript 1.7.1
(function() {
  var Application, express, path;

  express = require('express');

  path = require('path');

  Application = (function() {
    function Application(config, db) {
      var ext, extensions, host, imagePath, mime, port, _i, _len, _ref, _ref1;
      this.config = config;
      this.db = db;
      this.app = express();
      this.app.use(require('./authorization')(config, db));
      this.app.use(require('./fileparser')(config));
      extensions = [
        (function() {
          var _i, _len, _ref, _results;
          _ref = this.config.allowedMimeTypes;
          _results = [];
          for (ext = _i = 0, _len = _ref.length; _i < _len; ext = ++_i) {
            mime = _ref[ext];
            _results.push(mime);
          }
          return _results;
        }).call(this)
      ];
      imagePath = "(" + (this.config.basePath.replace(/\//g, '\\/')) + "[a-zA-Z0-9]+\.(?:" + extensions + "))";
      this.app.get(new RegExp(imagePath), this.serveImage);
      this.app.get('/', this.serveIndex);
      _ref = this.config.bindAddresses;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        _ref1 = _ref[_i], host = _ref1[0], port = _ref1[1];
        this.app.listen(port, host);
      }
    }

    Application.prototype.serveIndex = function(req, res) {
      return res.redirect('https://github.com/calzoneman/simplesnap');
    };

    Application.prototype.serveImage = function(req, res) {
      return res.sendFile(req.params[0], {
        root: this.config.storageDir
      });
    };

    return Application;

  })();

  module.exports = Application;

}).call(this);
